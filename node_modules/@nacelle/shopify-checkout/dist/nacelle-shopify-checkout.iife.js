(()=>{var M=Object.defineProperty;var v=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var A=(p,f,h)=>f in p?M(p,f,{enumerable:!0,configurable:!0,writable:!0,value:h}):p[f]=h,I=(p,f)=>{for(var h in f||(f={}))W.call(f,h)&&A(p,h,f[h]);if(v)for(var h of v(f))X.call(f,h)&&A(p,h,f[h]);return p};var y=(p,f,h)=>new Promise((m,E)=>{var $=d=>{try{k(h.next(d))}catch(b){E(b)}},g=d=>{try{k(h.throw(d))}catch(b){E(b)}},k=d=>d.done?m(d.value):Promise.resolve(d.value).then($,g);k((h=h.apply(p,f)).next())});var F=function(){"use strict";function p({id:e,webUrl:o}){return{id:e,url:o,completed:!1}}function f({cartItems:e}){return e.map(c=>{const{quantity:t,variantId:a}=c,l=S(a);return{customAttributes:b({metafields:c.metafields}),quantity:t,variantId:l}})}function h(e){var c,t;return((t=(c=e==null?void 0:e.split(".myshopify").shift())==null?void 0:c.split("//").pop())==null?void 0:t.split(".").pop())||e}const m="[@nacelle/shopify-checkout] in order to create a checkout server-side, you must provide a fetch API-compatible `fetchClient` capable of running on both the client & server. Examples include `isomorphic-unfetch` and `cross-fetch`.",E="[@nacelle/shopify-checkout]: missing required parameters. Either use both `myshopifyDomain` and `storefrontApiVersion`, or provide a `customEndpoint`.";function $({customEndpoint:e,fetchClient:o,myshopifyDomain:c,storefrontApiVersion:t,storefrontCheckoutToken:a}){return({query:u,variables:n})=>{let r=e;if(!r){if(!c||!t)throw new Error(E);r=`https://${h(c||"")}.myshopify.com/api/${t}/graphql`}let i=o;if(!i)if(typeof window!="undefined")i=window.fetch;else throw new Error(m);return i(r,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-Shopify-Storefront-Access-Token":a},body:JSON.stringify({query:u,variables:n})}).then(s=>s.json())}}function g(e,...o){return e.reduce((c,t,a)=>`${c}${t}${o[a]||""}`,"")}function k(e,{caller:o,message:c}={}){let t="";throw o&&(t=`[${o}] `),t=t+(c||"Shopify Storefront API Errors:")+(e?`
`+JSON.stringify(e,null,2):""),new Error(t)}function d(e){return(e==null?void 0:e.length)?e.includes("Z2lkOi8vc2hvcGlmeS9DaGVja291dC8")&&e!=="":!1}function b({metafields:e}){return!Array.isArray(e)||!(e==null?void 0:e.length)?[]:e==null?void 0:e.reduce((c,t)=>(typeof t.value=="string"?c.push({key:t.key,value:t.value}):console.warn(`Omitting custom attribute "${t.key}" because it has a non-string value.`),c),[])}function S(e){if(U(e))return e;if(V(e))return L(e);const o=q(e);if(U(o))return o;throw Error(`${e} is an invalid shopify variant id`)}function U(e){return e.startsWith("gid://shopify/")}function V(e){return!Number.isNaN(Number(e))}function q(e){try{return typeof window=="undefined"?Buffer.from(e,"base64").toString("base64")===e?Buffer.from(e,"base64").toString():e:window.atob(e)}catch(o){return e}}function L(e){return`gid://shopify/ProductVariant/${e}`}const D=g`mutation checkoutCreate($input: CheckoutCreateInput!) { checkoutCreate(input: $input) { checkout { id webUrl } checkoutUserErrors { code field message } } }`,R=g`mutation checkoutLineItemsReplace( $lineItems: [CheckoutLineItemInput!]! $checkoutId: ID! ) { checkoutLineItemsReplace(lineItems: $lineItems, checkoutId: $checkoutId) { checkout { id webUrl } userErrors { code field message } } }`,N=g`mutation checkoutAttributesUpdate( $checkoutId: ID! $input: CheckoutAttributesUpdateV2Input! ) { checkoutAttributesUpdateV2(checkoutId: $checkoutId, input: $input) { checkout { id webUrl } checkoutUserErrors { code field message } } }`;function P(a){return y(this,arguments,function*({gqlClient:e,id:o,customAttributes:c,note:t}){const l=N,u={checkoutId:o,input:{customAttributes:c,note:t}},{data:n,errors:r}=yield e({query:l,variables:u}).catch(s=>{throw new Error(s)}),i=r||(n==null?void 0:n.checkoutAttributesUpdateV2.checkoutUserErrors);if((i==null?void 0:i.length)&&k(i,{caller:"checkoutAttributesUpdate"}),n==null?void 0:n.checkoutAttributesUpdateV2.checkout)return p(n.checkoutAttributesUpdateV2.checkout)})}function T(l){return y(this,arguments,function*({gqlClient:e,lineItems:o,customAttributes:c,note:t,queueToken:a}){const u=D,n={input:{customAttributes:c,lineItems:o,note:t},queueToken:a};try{const{data:r,errors:i}=yield e({query:u,variables:n}).catch(C=>{throw new Error(C)}),s=i||(r==null?void 0:r.checkoutCreate.checkoutUserErrors);if((s==null?void 0:s.length)&&k(i,{caller:"checkoutCreate"}),r==null?void 0:r.checkoutCreate.checkout)return p(r.checkoutCreate.checkout)}catch(r){throw new Error(String(r))}})}function G(t){return y(this,arguments,function*({gqlClient:e,lineItems:o,id:c}){const a=R,l={checkoutId:c,lineItems:o},{data:u,errors:n}=yield e({query:a,variables:l}).catch(i=>{throw new Error(i)}),r=n||(u==null?void 0:u.checkoutLineItemsReplace.userErrors);if((r==null?void 0:r.length)&&k(r,{caller:"checkoutLineItemsReplace"}),u==null?void 0:u.checkoutLineItemsReplace.checkout)return p(u.checkoutLineItemsReplace.checkout)})}const j=g`query getCheckout($id: ID!) { node(id: $id) { ... on Checkout { id webUrl completedAt } } }`;function B(c){return y(this,arguments,function*({gqlClient:e,id:o}){const t=j,a={id:o},{data:l,errors:u}=yield e({query:t,variables:a}).catch(n=>{throw new Error(n)});if(u&&k(u,{caller:"findCheckout"}),!(l==null?void 0:l.node))k(void 0,{caller:"findCheckout",message:"Checkout response has no data"});else{const{id:n,webUrl:r,completedAt:i}=l.node;return{completed:Boolean(i),id:n||"",url:r||""}}})}function O(u){return y(this,arguments,function*({gqlClient:e,id:o,lineItems:c,customAttributes:t,note:a,queueToken:l}){let n;const r=c==null?void 0:c.length,i=(t==null?void 0:t.length)||a;try{if(o){if(!d(o))throw new Error(`Invalid checkout ID. Expected a Base64-encoded Shopify Global ID. Received: ${o}`);const s=[];r&&s.push(G({gqlClient:e,id:o,lineItems:c})),i&&s.push(P({gqlClient:e,id:o,customAttributes:t,note:a})),yield Promise.allSettled(s).then(C=>C.forEach(w=>{if(w.status==="fulfilled"&&w.value)n=I(I({},n||{}),w.value);else if(w.status==="rejected")throw new Error(w.reason)}))}return typeof n=="undefined"&&typeof c!="undefined"&&(n=yield T({gqlClient:e,customAttributes:t,note:a,lineItems:c,queueToken:l})),n}catch(s){throw new Error(String(s))}})}function x({storefrontCheckoutToken:e,myshopifyDomain:o,storefrontApiVersion:c,customEndpoint:t,fetchClient:a}){const l=$({customEndpoint:t,fetchClient:a,myshopifyDomain:o,storefrontApiVersion:c,storefrontCheckoutToken:e});function u(i){return y(this,arguments,function*({id:r}){return yield B({gqlClient:l,id:r})})}function n(K){return y(this,arguments,function*({cartItems:r,id:i,metafields:s,note:C,queueToken:w}){const z=(r==null?void 0:r.length)?f({cartItems:r}):void 0,J=(s==null?void 0:s.length)?b({metafields:s}):void 0;return yield O({gqlClient:l,lineItems:z,id:i,customAttributes:J,note:C,queueToken:w})})}return{get:u,process:n}}return x}();})();
//# sourceMappingURL=nacelle-shopify-checkout.iife.js.map
